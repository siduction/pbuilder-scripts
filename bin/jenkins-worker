#!/bin/bash
PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games

## usage
usage()
{
cat << EOF
jenkins-buildpackage
usage: $0 options


OPTIONS:
   -h      Show this message
   -a      Architecture, should be 'i386' or 'amd64'
   -r      Repository: base, fixes, extra, kdenext, lxqt, razorqt, xfcenext
   -d      Distribution: unstable, next, experimental, sid
   -x      Delete file for failed builds
   -V      Version
EOF
}

## version
version() {
    . /usr/share/pbuilder-scripts/version
    echo "$(basename $0): ${VERSION}"
}

## get basic configuration form /etc/jenkins
if [ -f /etc/jenkins/jenkins-buildpackage.conf ]; then
#    echo -e "Configuration: /etc/jenkins/jenkins-buildpackage.conf used"
    . /etc/jenkins/jenkins-buildpackage.conf
fi

## get user conf
if [ -f ${HOME}/.config/jenkins/jenkins-buildpackage.conf ]; then
#    echo -e "Configuration: ${HOME}/.config/jenkins-buildpackage.conf  used"
    . ${HOME}/.config/jenkins/jenkins-builpackage.conf
fi


# really dirty - serverside base is defined fugly as can be for now
REPOBASE="/var/www/virtual/packages/${REPO}"
BUILDTARGET="/var/cache/pbuilder/${DISTRI}-${ARCH}/result"

## split_needs
split_needs() {
  REPO=$(echo ${i} | awk -F'-' '{ print $2 }')
  DISTRI=$(echo ${i} | awk -F'-' '{ print $3 }')
  ARCH=$(echo ${i} | awk -F'-' '{ print $4 }')
  echo "REPO: $REPO"
  echo "DISTRI: $DISTRI"
  echo "ARCH: $ARCH"
}




## Main
for i in ${SOURCEPATH}/needed* ; do
   if [ -f ${i} ]; then
       split_needs
       rm ${i}
       jenkins-buildpackage -r ${REPO} -d ${DISTRI} -a ${ARCH}
       break
   fi
done
jenkins-build-needed

