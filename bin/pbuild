#!/bin/bash
#
# pbuild
#
# © 2011-2014 Alf Gaida <agaida@siduction.org>
#
export ARCH="amd64"
export RELEASE="unstable"
export REPOSITORY="extra"
OPTIONS="${@}"
DSCFILE=$*
PACKAGEFILES=$(echo $DSCFILE | sed 's/\.dsc/*/')
CHANGESFILE=${PACKAGEFILES}changes

## usage
usage() {
cat << EOF
jenkins-buildpackage
usage: $0 options

OPTIONS:
    -h  Show this message
    -a  Architecture, should be 'i386', 'amd64'
    -d  Distribution: unstable, next, experimental
    -r  Repository: base, fixes, extra, kdenext, lxqt, razorqt, xfcenext
    -V  Version
EOF
}

while getopts “a:d:r:h” OPTION; do
     case ${OPTION} in
         a)
             export ARCH=${OPTARG}
             OPTIONS=$(echo ${OPTIONS} | sed -e "s/\-a//" -e "s/${OPTARG}//")
             ;;
         d)  export DIST=${OPTARG}
             OPTIONS=$(echo ${OPTIONS} | sed -e "s/\-d//" -e "s/${OPTARG}//")
             ;;
         r)
             export REPOSITORY=${OPTARG}
             OPTIONS=$(echo ${OPTIONS} | sed -e "s/\-r//" -e "s/${OPTARG}//")
             ;;
         h)
             usage
             exit 0
             ;;
     esac
done


## sign_builded_packages
sign_builded_packages() {
    echo -e "\nDEBUG:  ${BUILDRESULT}/${CHANGESFILE}"
    ls  ${BUILDRESULT}/${CHANGESFILE}
    echo -e "DEBUG end\n"
    debsign -k ${DEBSIGN_KEYID} ${BUILDRESULT}/${CHANGESFILE}
    RESULT=$?
    echo -e "sign_package Result: ${RESULT} \n"
    if [ $RESULT -ne "0" ]; then
        if [ "${FAILED}" != "true" ]; then
            write_failed
            FAILED="true"
        fi
    fi
}

. /usr/share/pbuilder-scripts/set_pbuilder

echo -e "\n"
echo -e "pbuild"
echo -e "Architectiure: $ARCH"
echo -e "Distibution:   $DIST"
echo -e "Release:       $RELEASE"
echo -e "Repository:    $REPOSITORY"
echo -e "Buildresult    $BUILDRESULT"
echo -e "DSC-File  :    $DSCFILE"
echo -e "Changes-File:  $CHANGESFILE"
echo -e "KEY:           $DEBSIGN_KEYID"
echo -e "\n"

sudo -E pbuilder --build ${OPTIONS}
RESULT=$?
if [ $RESULT -eq "0" ]; then
    sign_builded_packages
    RESULT=$?
fi
echo -e "Buildresult pbuild: $RESULT"
exit $RESULT

