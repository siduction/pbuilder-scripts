#!/bin/bash
#
# pbuild
#
# © 2011-2013 Alf Gaida <agaida@siduction.org>
#
export ARCH="amd64"
export DIST="unstable"
export RELEASE="unstable"
OPTIONS="${@}"

## usage
usage()
{
cat << EOF
jenkins-buildpackage
usage: $0 options

OPTIONS:
    -h  Show this message
    -a  Architecture, should be 'i386', 'amd64' or 'all'
    -d  Distribution: unstable, next, experimental
    -r  Repository: base, fixes, extra, kdenext, lxqt, razorqt, xfcenext
    -V  Version
EOF
}

## sign_builded_packages
sign_builded_packages() {
    echo "DEBUG:  ${BUILDTARGET}/${UPLOADFILES}changes"
    ls  ${BUILDTARGET}/${UPLOADFILES}changes
    echo "DEBUG end"
    debsign -k 53CD5927 ${BUILDTARGET}/${UPLOADFILES}changes
    RESULT=$?
    echo -e "sign_package Result: ${RESULT}"
    if [ $RESULT -ne "0" ]; then
        if [ "${FAILED}" != "true" ]; then
            write_failed
            FAILED="true"
        fi
    fi
}

while getopts “a:r:t:h” OPTION; do
     case ${OPTION} in
         a)
             export ARCH=${OPTARG}
             ;;
         d)
             export DIST=${OPTARG}
             ;;
         r)
             export REPOSITORY=${OPTARG}
             ;;
         h)
             usage
             exit 0
             ;;
     esac
done

OPTIONS=$(echo ${OPTIONS} | sed -e "s/\-r//" -e "s/${OPTARG}//")
. /usr/share/pbuilder-scripts/set_pbuilder

echo -e "Options: ${OPTIONS}"
sudo -E pbuilder --build ${OPTIONS}
RESULT=$?

# signing

echo -e "\nBuildresult pbuild: $RESULT \n"
exit $RESULT
